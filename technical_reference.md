# üß† JoyBucket Technical Reference

This document captures the advanced technical patterns and "hard-won" discoveries made during the development of JoyBucket. Use this to avoid wasting time on configuration issues in future builds.

---

## üé® Tailwind CSS v4 Configuration

### Dark Mode (Selector Strategy)
Tailwind v4 has moved to a **CSS-first** configuration. The traditional `darkMode: 'class'` in `tailwind.config.js` is no longer the primary method for manual toggling.

**Implementation**: 
Add this to your `input.css` to force support for the `.dark` class:
```css
@import "tailwindcss";

/* Enable class-based dark mode for Tailwind v4 */
@custom-variant dark (&:where(.dark, .dark *));
```

### Build Command
Always use the local CLI for consistent results:
```bash
npm run build:css
# Executes: npx @tailwindcss/cli -i ./static/css/input.css -o ./static/css/output.css --minify
```

---

## ‚ö° HTMX Dynamic Patterns

### Background Task Status Polling
Used for real-time updates of AI analysis without page refreshes.

**The Pattern**:
1. **Backend**: Create a status-only endpoint (`/entry/{id}/status`) that returns the updated HTML fragment.
2. **Frontend**: Add polling attributes *only* to elements in a pending state.

```html
<div id="entry-{{ id }}"
    {% if not entry.category %}
    hx-get="/entry/{{ id }}/status"
    hx-trigger="every 2s"
    hx-swap="outerHTML"
    {% endif %}>
    <!-- Content -->
</div>
```
*Note: When the category is populated, the `if` condition fails, and polling automatically stops.*

---

## üé§ Voice Logging (Speech-to-Text)

Implemented via the **Web Speech API**.

**Key Discoveries**:
- **WebKit Prefix**: Always include `window.webkitSpeechRecognition` for Safari/Chrome compatibility.
- **Continuous Mode**: Set `continuous = false` for "one-shot" logging which is more natural for short journal entries.
- **UI State**: Toggle a CSS class (like `animate-pulse` or a color change) on the `onstart` and `onend` events to prevent user confusion.

---

## üìä SVG Sparklines

Generated via Jinja2 loops to avoid heavy charting libraries.

**Implementation Logic**:
- Map scores (0-10) to a coordinate system (e.g., 0-40 height).
- Use a single `<path>` element with the `d` attribute generated by a string of coordinates.
- **Trajectory**: Comparing the average of the last 3 items vs the previous 3 to identify the "Soul Trajectory" (Thriving/Struggling).

---

## üõ°Ô∏è Authentication & Security

### `itsdangerous`
Required for session signing in `fastapi-sso`. If it's missing, Google OAuth will fail with an internal error during the callback phase. Ensure it is explicitly in `requirements.txt`.

### Google OAuth Test Users
While in "Testing" mode in Google Cloud Console, **all users must be manually whitelisted** in the "Test users" section of the OAuth consent screen, or they will receive a 403 error.
